<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EasyPick Edge Functions Frontend Test</title>
    <style>
        body { font-family: -apple-system, system-ui, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .info { color: #007bff; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        #results { background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 4px; font-family: monospace; white-space: pre-wrap; }
        input[type="text"] { padding: 8px; margin: 5px; border: 1px solid #ddd; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>ğŸ§ª EasyPick Edge Functions Frontend Test</h1>
    <p>ì´ í˜ì´ì§€ì—ì„œ Edge Functionsì˜ í”„ë¡ íŠ¸ì—”ë“œ ì—°ë™ì„ í…ŒìŠ¤íŠ¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

    <div class="test-section">
        <h2>âš™ï¸ ì„¤ì •</h2>
        <label>
            Supabase URL:
            <input type="text" id="supabaseUrl" value="http://127.0.0.1:54321" style="width: 300px;">
        </label><br>
        <label>
            JWT Token (ì„ íƒ):
            <input type="text" id="jwtToken" placeholder="Bearer token (ì„ íƒì‚¬í•­)" style="width: 400px;">
        </label>
    </div>

    <div class="test-section">
        <h2>ğŸ“Š Events API Tests</h2>
        <button onclick="testSingleEvent()">ë‹¨ì¼ ì´ë²¤íŠ¸ í…ŒìŠ¤íŠ¸</button>
        <button onclick="testBatchEvents()">ë°°ì¹˜ ì´ë²¤íŠ¸ í…ŒìŠ¤íŠ¸</button>
        <button onclick="testInvalidEvent()">ì˜ëª»ëœ ì´ë²¤íŠ¸ í…ŒìŠ¤íŠ¸</button>
        <button onclick="testAuthenticatedEvent()">ì¸ì¦ëœ ì´ë²¤íŠ¸ í…ŒìŠ¤íŠ¸</button>
    </div>

    <div class="test-section">
        <h2>ğŸ›¡ï¸ Guard API Tests</h2>
        <button onclick="testGuardNoAuth()">ì¸ì¦ ì—†ìŒ í…ŒìŠ¤íŠ¸</button>
        <button onclick="testGuardWithAuth()">ì¸ì¦ í¬í•¨ í…ŒìŠ¤íŠ¸</button>
    </div>

    <div class="test-section">
        <h2>ğŸ”— Integration Tests</h2>
        <button onclick="testFullWorkflow()">ì „ì²´ ì›Œí¬í”Œë¡œìš° í…ŒìŠ¤íŠ¸</button>
        <button onclick="testAnalyticsLib()">Analytics ë¼ì´ë¸ŒëŸ¬ë¦¬ í…ŒìŠ¤íŠ¸</button>
    </div>

    <div class="test-section">
        <h2>ğŸ“‹ ê²°ê³¼</h2>
        <button onclick="clearResults()">ê²°ê³¼ ì§€ìš°ê¸°</button>
        <div id="results">í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•˜ë©´ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
    </div>

    <script>
        let testResults = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const colorClass = type;
            const formattedMessage = `[${timestamp}] ${message}`;
            
            testResults.push(formattedMessage);
            document.getElementById('results').innerHTML = testResults.join('\n');
            
            console.log(formattedMessage);
        }

        function clearResults() {
            testResults = [];
            document.getElementById('results').innerHTML = 'Results cleared.';
        }

        async function makeRequest(endpoint, options = {}) {
            const supabaseUrl = document.getElementById('supabaseUrl').value;
            const url = `${supabaseUrl}/functions/v1/${endpoint}`;
            
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });

                const responseText = await response.text();
                let data = {};
                
                try {
                    data = JSON.parse(responseText);
                } catch {
                    data = { raw: responseText };
                }

                return {
                    status: response.status,
                    data,
                    ok: response.ok
                };
            } catch (error) {
                log(`Request failed: ${error.message}`, 'error');
                return {
                    status: 0,
                    data: { error: error.message },
                    ok: false
                };
            }
        }

        // ========================================
        // EVENTS API TESTS
        // ========================================

        async function testSingleEvent() {
            log('ğŸ§ª Testing single event...', 'info');
            
            const response = await makeRequest('events', {
                body: JSON.stringify({
                    name: 'test_single_event',
                    params: {
                        user_action: 'button_click',
                        page: '/test',
                        test_timestamp: new Date().toISOString()
                    },
                    ts: new Date().toISOString()
                })
            });

            if (response.status === 200 && response.data.success) {
                log(`âœ… Single event test passed: processed ${response.data.processed} events`, 'success');
            } else {
                log(`âŒ Single event test failed: ${response.status} - ${JSON.stringify(response.data)}`, 'error');
            }
        }

        async function testBatchEvents() {
            log('ğŸ§ª Testing batch events...', 'info');
            
            const events = [
                { name: 'page_view', params: { page: '/home' } },
                { name: 'click', params: { element: 'button' } },
                { name: 'compile_prompt', params: { template_id: 'test_123', model: 'gpt-4' } }
            ];

            const response = await makeRequest('events', {
                body: JSON.stringify(events)
            });

            if (response.status === 200 && response.data.success) {
                log(`âœ… Batch events test passed: processed ${response.data.processed} events`, 'success');
            } else {
                log(`âŒ Batch events test failed: ${response.status} - ${JSON.stringify(response.data)}`, 'error');
            }
        }

        async function testInvalidEvent() {
            log('ğŸ§ª Testing invalid event...', 'info');
            
            const response = await makeRequest('events', {
                body: JSON.stringify({
                    invalid: 'data',
                    no_name: true
                })
            });

            if (response.status === 400 && response.data.code === 'NO_VALID_EVENTS') {
                log('âœ… Invalid event test passed: correctly rejected invalid data', 'success');
            } else {
                log(`âŒ Invalid event test failed: expected 400/NO_VALID_EVENTS, got ${response.status} - ${JSON.stringify(response.data)}`, 'error');
            }
        }

        async function testAuthenticatedEvent() {
            log('ğŸ§ª Testing authenticated event...', 'info');
            
            const token = document.getElementById('jwtToken').value;
            if (!token) {
                log('âš ï¸ No JWT token provided, skipping authenticated test', 'info');
                return;
            }

            const response = await makeRequest('events', {
                headers: {
                    'Authorization': token.startsWith('Bearer ') ? token : `Bearer ${token}`
                },
                body: JSON.stringify({
                    name: 'authenticated_event',
                    params: {
                        action: 'premium_feature',
                        authenticated: true
                    }
                })
            });

            if (response.status === 200 && response.data.success) {
                log(`âœ… Authenticated event test passed: processed ${response.data.processed} events`, 'success');
            } else {
                log(`âŒ Authenticated event test failed: ${response.status} - ${JSON.stringify(response.data)}`, 'error');
            }
        }

        // ========================================
        // GUARD API TESTS  
        // ========================================

        async function testGuardNoAuth() {
            log('ğŸ›¡ï¸ Testing guard without auth...', 'info');
            
            const response = await makeRequest('guard', {
                body: JSON.stringify({})
            });

            if (response.status === 401 && response.data.code === 'INVALID_TOKEN') {
                log('âœ… Guard no-auth test passed: correctly rejected unauthorized request', 'success');
            } else {
                log(`âŒ Guard no-auth test failed: expected 401/INVALID_TOKEN, got ${response.status} - ${JSON.stringify(response.data)}`, 'error');
            }
        }

        async function testGuardWithAuth() {
            log('ğŸ›¡ï¸ Testing guard with auth...', 'info');
            
            const token = document.getElementById('jwtToken').value;
            if (!token) {
                log('âš ï¸ No JWT token provided, skipping authenticated guard test', 'info');
                return;
            }

            const response = await makeRequest('guard', {
                headers: {
                    'Authorization': token.startsWith('Bearer ') ? token : `Bearer ${token}`
                },
                body: JSON.stringify({})
            });

            if (response.status === 200) {
                log(`âœ… Guard auth test passed: ${JSON.stringify(response.data)}`, 'success');
            } else if (response.status === 402) {
                log(`âš ï¸ Guard auth test: quota exceeded (402) - ${JSON.stringify(response.data)}`, 'info');
            } else if (response.status === 404) {
                log(`âš ï¸ Guard auth test: user not found in database (404) - ${JSON.stringify(response.data)}`, 'info');
            } else {
                log(`âŒ Guard auth test failed: ${response.status} - ${JSON.stringify(response.data)}`, 'error');
            }
        }

        // ========================================
        // INTEGRATION TESTS
        // ========================================

        async function testFullWorkflow() {
            log('ğŸ”— Testing full workflow (Guard â†’ Events)...', 'info');
            
            const token = document.getElementById('jwtToken').value;
            if (!token) {
                log('âš ï¸ No JWT token provided, testing without authentication', 'info');
            }

            const headers = token ? {
                'Authorization': token.startsWith('Bearer ') ? token : `Bearer ${token}`
            } : {};

            // Step 1: Check guard
            log('Step 1: Checking guard...', 'info');
            const guardResponse = await makeRequest('guard', {
                headers,
                body: JSON.stringify({})
            });

            log(`Guard response: ${guardResponse.status} - ${JSON.stringify(guardResponse.data)}`, 'info');

            // Step 2: Send event based on guard result
            log('Step 2: Sending event...', 'info');
            const eventResponse = await makeRequest('events', {
                headers,
                body: JSON.stringify({
                    name: 'workflow_test',
                    params: {
                        guard_status: guardResponse.status,
                        guard_allowed: guardResponse.status === 200,
                        workflow_step: 'integration_test'
                    }
                })
            });

            if (eventResponse.status === 200 && eventResponse.data.success) {
                log(`âœ… Full workflow test passed: Guard(${guardResponse.status}) â†’ Event(${eventResponse.status})`, 'success');
            } else {
                log(`âŒ Full workflow test failed: Event step failed with ${eventResponse.status}`, 'error');
            }
        }

        async function testAnalyticsLib() {
            log('ğŸ“Š Testing analytics library integration...', 'info');
            
            // Simulate analytics library usage
            const mockAnalyticsEvent = {
                event_name: 'analytics_lib_test',
                user_id: 'test_user',
                session_id: `session_${Date.now()}`,
                timestamp: new Date().toISOString(),
                page_url: window.location.href,
                page_title: document.title,
                user_agent: navigator.userAgent,
                custom_param: 'analytics_integration'
            };

            // Convert to expected format
            const eventData = {
                name: mockAnalyticsEvent.event_name,
                params: {
                    user_id: mockAnalyticsEvent.user_id,
                    session_id: mockAnalyticsEvent.session_id,
                    page_url: mockAnalyticsEvent.page_url,
                    page_title: mockAnalyticsEvent.page_title,
                    user_agent: mockAnalyticsEvent.user_agent,
                    custom_param: mockAnalyticsEvent.custom_param
                },
                ts: mockAnalyticsEvent.timestamp
            };

            const response = await makeRequest('events', {
                body: JSON.stringify(eventData)
            });

            if (response.status === 200 && response.data.success) {
                log('âœ… Analytics library integration test passed', 'success');
            } else {
                log(`âŒ Analytics library integration test failed: ${response.status} - ${JSON.stringify(response.data)}`, 'error');
            }
        }

        // Initialize
        log('EasyPick Edge Functions Frontend Test initialized', 'info');
        log('Configure your Supabase URL and JWT token above, then run tests', 'info');
    </script>
</body>
</html>